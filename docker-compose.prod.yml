version: '3.9'

services:
  # =======================
  # PostgreSQL
  # =======================
  db:
    image: postgres:15
    container_name: visasaigon_db
    restart: always
    env_file:
      - ./backend/.env.prod
    volumes:
      - visasaigon_postgres_data:/var/lib/postgresql/data
    networks:
      - visasaigon_network
    # Production không expose DB ra ngoài
    # Nếu cần truy cập tạm thời, bạn ssh vào server

  # =======================
  # Django + Gunicorn
  # =======================
  web:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    image: visasaigon_backend
    container_name: visasaigon_web
    restart: always
    env_file:
      - ./backend/.env.prod
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.prod
    depends_on:
      - db
    networks:
      - visasaigon_network
    volumes:
      # Chia sẻ static/media để nginx đọc được
      - ./backend/static:/app/static
      - ./backend/media:/app/media

  # =======================
  # NGINX Reverse Proxy
  # =======================
  nginx:
    image: nginx:latest
    container_name: visasaigon_nginx
    restart: always
    depends_on:
      - web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # File nginx.conf của bạn nằm trong backend/docker/
      - ./backend/docker/nginx.conf:/etc/nginx/nginx.conf:ro

      # Static & media mount từ web → nginx serve
      - ./backend/static:/app/static
      - ./backend/media:/app/media

      # Certbot (nếu bạn dùng HTTPS)
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./nginx/certbot/www:/var/www/certbot

    networks:
      - visasaigon_network

volumes:
  visasaigon_postgres_data:

networks:
  visasaigon_network:
    driver: bridge
